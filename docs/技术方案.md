# Conflict Archaeology 技术方案

## 1. 技术栈概览

| 类别 | 技术选型 | 版本 |
|---|---|---|
| 框架 | Next.js (App Router) | 15.x |
| 样式 | Tailwind CSS | v4 |
| 动效 | Framer Motion | 11.x |
| 图标 | Lucide React | latest |
| AI SDK | Vercel AI SDK | 5.x |
| Schema | Zod | 3.x |
| 本地存储 | Dexie (IndexedDB) | 4.x |
| PDF 导出 | pdf-lib | latest |
| 语言 | TypeScript | 5.x |

---

## 2. 项目结构

```
conflict-archaeology/
├── src/
│   ├── app/                          # Next.js App Router
│   │   ├── layout.tsx                # 根布局
│   │   ├── page.tsx                  # 首页（Landing）
│   │   ├── globals.css               # 全局样式
│   │   │
│   │   ├── session/
│   │   │   └── [id]/
│   │   │       ├── page.tsx          # 会话主页（路由分发）
│   │   │       ├── calm-down/        # 阶段1：平复自己
│   │   │       │   └── page.tsx
│   │   │       ├── input/            # 阶段2：输入对话
│   │   │       │   └── page.tsx
│   │   │       ├── review/           # 阶段2结果：理解双方
│   │   │       │   └── page.tsx
│   │   │       ├── insights/         # 阶段3：视角转换
│   │   │       │   └── page.tsx
│   │   │       ├── reconnect/        # 阶段4：重建连接
│   │   │       │   └── page.tsx
│   │   │       └── export/           # 阶段5：导出
│   │   │           └── page.tsx
│   │   │
│   │   ├── paused/                   # 暂停页面
│   │   │   └── page.tsx
│   │   │
│   │   └── api/
│   │       └── analyze/
│   │           └── route.ts          # AI 分析 API
│   │
│   ├── components/
│   │   ├── ui/                       # 基础 UI 组件
│   │   │   ├── button.tsx
│   │   │   ├── card.tsx
│   │   │   ├── dialog.tsx
│   │   │   ├── input.tsx
│   │   │   ├── textarea.tsx
│   │   │   └── ...
│   │   │
│   │   ├── layout/                   # 布局组件
│   │   │   ├── header.tsx
│   │   │   ├── footer.tsx
│   │   │   ├── global-safety-button.tsx
│   │   │   └── stage-progress.tsx
│   │   │
│   │   ├── calm-down/                # 平复自己相关组件
│   │   │   ├── emotion-check-in.tsx
│   │   │   ├── breathing-guide.tsx
│   │   │   ├── wisdom-quote.tsx
│   │   │   └── readiness-confirm.tsx
│   │   │
│   │   ├── dialogue/                 # 对话输入相关组件
│   │   │   ├── message-input.tsx
│   │   │   ├── message-list.tsx
│   │   │   ├── image-upload.tsx
│   │   │   └── context-input.tsx
│   │   │
│   │   ├── analysis/                 # 分析结果相关组件
│   │   │   ├── overview-section.tsx
│   │   │   ├── timeline-section.tsx
│   │   │   ├── message-item.tsx
│   │   │   ├── perspectives-section.tsx
│   │   │   ├── key-moments-section.tsx
│   │   │   └── emotion-curve.tsx
│   │   │
│   │   ├── insights/                 # 视角转换相关组件
│   │   │   ├── insight-card.tsx
│   │   │   ├── misconception-frame.tsx
│   │   │   └── insight-saver.tsx
│   │   │
│   │   ├── reconnect/                # 重建连接相关组件
│   │   │   ├── understanding-template.tsx
│   │   │   ├── opening-suggestions.tsx
│   │   │   └── timing-advice.tsx
│   │   │
│   │   └── safety/                   # 安全相关组件
│   │       ├── safety-screen.tsx
│   │       ├── caution-banner.tsx
│   │       └── safety-resources.tsx
│   │
│   ├── lib/
│   │   ├── schemas/                  # Zod Schemas
│   │   │   ├── index.ts              # 导出所有 schema
│   │   │   ├── dialogue.ts           # 对话输入 schema
│   │   │   ├── analysis.ts           # 分析结果 schema
│   │   │   ├── session.ts            # 会话状态 schema
│   │   │   └── emotion.ts            # 情绪相关 schema
│   │   │
│   │   ├── ai/
│   │   │   ├── prompts.ts            # System prompt 和模板
│   │   │   ├── analyze.ts            # AI 分析函数
│   │   │   └── config.ts             # AI 配置
│   │   │
│   │   ├── db/
│   │   │   ├── index.ts              # Dexie 数据库配置
│   │   │   ├── sessions.ts           # 会话 CRUD
│   │   │   └── insights.ts           # 洞察收藏 CRUD
│   │   │
│   │   ├── utils/
│   │   │   ├── cn.ts                 # className 合并
│   │   │   ├── format.ts             # 格式化工具
│   │   │   └── export-pdf.ts         # PDF 导出
│   │   │
│   │   └── constants/
│   │       ├── safety-resources.ts   # 求助热线信息
│   │       ├── book-quotes.ts        # 书中金句
│   │       └── emotions.ts           # 情绪选项
│   │
│   ├── hooks/
│   │   ├── use-session.ts            # 会话状态管理
│   │   ├── use-is-mobile.ts          # 响应式检测
│   │   ├── use-analysis.ts           # 分析状态管理
│   │   └── use-local-storage.ts      # localStorage hook
│   │
│   └── contexts/
│       └── session-context.tsx       # 会话上下文
│
├── public/
│   └── ...
│
├── docs/                             # 文档
│   ├── 需求描述v2.md
│   ├── 技术方案.md
│   └── 走进他人的心.md
│
└── package.json
```

---

## 3. 核心数据流

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户交互层                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Landing     Calm Down     Input      Review     Reconnect     │
│      │            │           │           │           │         │
│      └────────────┴───────────┴───────────┴───────────┘         │
│                           │                                     │
│                    SessionContext                               │
│                           │                                     │
├─────────────────────────────────────────────────────────────────┤
│                         数据层                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│   │  IndexedDB  │    │   AI API    │    │ localStorage │        │
│   │  (Dexie)    │    │  (Vercel)   │    │  (Safety)   │        │
│   └─────────────┘    └─────────────┘    └─────────────┘        │
│         │                  │                  │                 │
│    会话/洞察            分析结果            求助热线             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. API 设计

### 4.1 分析 API (`/api/analyze`)

**请求**：
```typescript
POST /api/analyze
Content-Type: application/json

{
  "messages": [
    { "speaker": "我", "text": "你为什么总是这样？" },
    { "speaker": "TA", "text": "我怎么了？" }
  ],
  "context": "我们结婚三年了，最近工作压力都很大",
  "images": [
    { "base64": "...", "mimeType": "image/png" }
  ]
}
```

**响应**：流式返回 `ConflictAnalysisSchema` 对象

### 4.2 流式处理实现

```typescript
// src/app/api/analyze/route.ts
import { streamObject } from 'ai';
import { openai } from '@ai-sdk/openai';
import { ConflictAnalysisSchema, DialogueInputSchema } from '@/lib/schemas';
import { SYSTEM_PROMPT, formatPrompt } from '@/lib/ai/prompts';

export const maxDuration = 60; // 允许最长 60 秒

export async function POST(req: Request) {
  try {
    const input = DialogueInputSchema.parse(await req.json());

    // 构建消息（支持多模态）
    const messages = [];

    if (input.images?.length) {
      messages.push({
        role: 'user' as const,
        content: [
          { type: 'text' as const, text: '请识别以下聊天截图中的对话内容：' },
          ...input.images.map(img => ({
            type: 'image' as const,
            image: img.base64,
          })),
        ],
      });
    }

    messages.push({
      role: 'user' as const,
      content: formatPrompt(input),
    });

    const result = streamObject({
      model: openai('gpt-4o'),
      schema: ConflictAnalysisSchema,
      system: SYSTEM_PROMPT,
      messages,
      temperature: 0.3,
    });

    return result.toTextStreamResponse();
  } catch (error) {
    console.error('Analysis failed:', error);
    return new Response(
      JSON.stringify({ error: '分析过程中遇到问题，请稍后重试' }),
      { status: 500 }
    );
  }
}
```

---

## 5. 前端组件架构

### 5.1 会话状态管理

```typescript
// src/contexts/session-context.tsx
'use client';

import { createContext, useContext, useEffect, useState } from 'react';
import { Session, SessionSchema } from '@/lib/schemas';
import { db } from '@/lib/db';

interface SessionContextValue {
  session: Session | null;
  updateSession: (updates: Partial<Session>) => Promise<void>;
  goToStage: (stage: Session['stage']) => Promise<void>;
  pauseSession: () => Promise<void>;
}

const SessionContext = createContext<SessionContextValue | null>(null);

export function SessionProvider({
  sessionId,
  children
}: {
  sessionId: string;
  children: React.ReactNode
}) {
  const [session, setSession] = useState<Session | null>(null);

  useEffect(() => {
    db.sessions.get(sessionId).then(setSession);
  }, [sessionId]);

  const updateSession = async (updates: Partial<Session>) => {
    if (!session) return;
    const updated = {
      ...session,
      ...updates,
      updatedAt: new Date().toISOString()
    };
    await db.sessions.put(updated);
    setSession(updated);
  };

  const goToStage = async (stage: Session['stage']) => {
    await updateSession({ stage });
  };

  const pauseSession = async () => {
    if (!session) return;
    await updateSession({
      stage: 'paused',
      pausedFromStage: session.stage
    });
  };

  return (
    <SessionContext.Provider value={{ session, updateSession, goToStage, pauseSession }}>
      {children}
    </SessionContext.Provider>
  );
}

export const useSession = () => {
  const context = useContext(SessionContext);
  if (!context) throw new Error('useSession must be used within SessionProvider');
  return context;
};
```

### 5.2 分析结果流式渲染

```typescript
// src/components/analysis/analysis-view.tsx
'use client';

import { experimental_useObject as useObject } from '@ai-sdk/react';
import { useEffect } from 'react';
import { ConflictAnalysisSchema, DialogueInput } from '@/lib/schemas';
import { SafetyScreen } from '@/components/safety/safety-screen';
import { LoadingWithSafetyHint } from '@/components/safety/loading-with-safety-hint';
import { CautionBanner } from '@/components/safety/caution-banner';
import { OverviewSection } from './overview-section';
import { TimelineSection } from './timeline-section';
import { PerspectivesSection } from './perspectives-section';
import { KeyMomentsSection } from './key-moments-section';
import { InsightsSection } from './insights-section';
import { ReconnectionSection } from './reconnection-section';

interface AnalysisViewProps {
  input: DialogueInput;
  onComplete: (analysis: z.infer<typeof ConflictAnalysisSchema>) => void;
}

export function AnalysisView({ input, onComplete }: AnalysisViewProps) {
  const { object, submit, isLoading, error } = useObject({
    api: '/api/analyze',
    schema: ConflictAnalysisSchema,
    onFinish: ({ object }) => {
      if (object) onComplete(object);
    },
  });

  useEffect(() => {
    submit(input);
  }, [submit, input]);

  // 安全优先：危险级别立即阻断
  if (object?.safety?.level === 'danger') {
    return <SafetyScreen concern={object.safety.concern} />;
  }

  return (
    <div className="space-y-8">
      {/* 加载状态 */}
      {isLoading && !object && <LoadingWithSafetyHint />}

      {/* 错误处理 */}
      {error && (
        <div className="text-red-500 p-4 rounded-lg bg-red-50">
          分析过程中遇到问题，请稍后重试
        </div>
      )}

      {/* 渐进式显示 */}
      {object?.overview && <OverviewSection data={object.overview} />}
      {object?.messages && <TimelineSection messages={object.messages} />}
      {object?.perspectives && <PerspectivesSection data={object.perspectives} />}
      {object?.keyMoments && <KeyMomentsSection moments={object.keyMoments} />}
      {object?.insights && <InsightsSection insights={object.insights} />}
      {object?.reconnection && <ReconnectionSection data={object.reconnection} />}

      {/* 警告横幅 */}
      <CautionBanner show={object?.safety?.level === 'caution'} />
    </div>
  );
}
```

### 5.3 时间线消息组件（响应式）

```typescript
// src/components/analysis/message-item.tsx
'use client';

import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { MessageInsight } from '@/lib/schemas';
import { useIsMobile } from '@/hooks/use-is-mobile';
import { cn } from '@/lib/utils/cn';

interface MessageItemProps {
  insight: MessageInsight;
  isKeyMoment?: boolean;
}

export function MessageItem({ insight, isKeyMoment }: MessageItemProps) {
  const isMobile = useIsMobile();
  const [expanded, setExpanded] = useState(false);

  const isMe = insight.speaker === '我';

  const DetailPanel = () => (
    <motion.div
      initial={{ opacity: 0, height: 0 }}
      animate={{ opacity: 1, height: 'auto' }}
      exit={{ opacity: 0, height: 0 }}
      className="mt-2 p-3 bg-gray-50 rounded-lg text-sm space-y-2"
    >
      <div>
        <span className="font-medium">我的视角：</span>
        <p className="text-gray-600">{insight.myPerspective.emotion}</p>
        <p className="text-gray-500 text-xs">
          可能在担心：{insight.myPerspective.fear}
        </p>
      </div>
      <div>
        <span className="font-medium">TA的视角：</span>
        <p className="text-gray-600">{insight.theirPerspective.emotion}</p>
        <p className="text-gray-500 text-xs">
          可能在担心：{insight.theirPerspective.fear}
        </p>
      </div>
    </motion.div>
  );

  // 移动端：点击展开
  if (isMobile) {
    return (
      <div
        onClick={() => setExpanded(!expanded)}
        className={cn(
          'p-4 rounded-lg cursor-pointer transition-colors',
          isMe ? 'bg-blue-50 ml-8' : 'bg-gray-100 mr-8',
          isKeyMoment && 'ring-2 ring-amber-400'
        )}
      >
        <div className="flex items-start gap-2">
          <span className="text-xs text-gray-500">{insight.speaker}</span>
          {isKeyMoment && <span className="text-xs text-amber-600">关键时刻</span>}
        </div>
        <p className="mt-1">{insight.originalText}</p>
        <AnimatePresence>
          {expanded && <DetailPanel />}
        </AnimatePresence>
      </div>
    );
  }

  // 桌面端：hover 显示
  return (
    <div
      className={cn(
        'group p-4 rounded-lg transition-colors',
        isMe ? 'bg-blue-50 ml-16' : 'bg-gray-100 mr-16',
        isKeyMoment && 'ring-2 ring-amber-400'
      )}
    >
      <div className="flex items-start gap-2">
        <span className="text-xs text-gray-500">{insight.speaker}</span>
        {isKeyMoment && <span className="text-xs text-amber-600">关键时刻</span>}
      </div>
      <p className="mt-1">{insight.originalText}</p>
      <div className="hidden group-hover:block">
        <DetailPanel />
      </div>
    </div>
  );
}
```

---

## 6. 本地存储方案

### 6.1 Dexie 数据库配置

```typescript
// src/lib/db/index.ts
import Dexie, { Table } from 'dexie';
import { Session, SavedInsight } from '@/lib/schemas';

export class ConflictArchaeologyDB extends Dexie {
  sessions!: Table<Session>;
  insights!: Table<SavedInsight>;

  constructor() {
    super('ConflictArchaeologyDB');
    this.version(1).stores({
      sessions: 'id, stage, createdAt, updatedAt',
      insights: 'id, type, savedAt',
    });
  }
}

export const db = new ConflictArchaeologyDB();

// 自动清理 30 天前的会话
export async function cleanupOldSessions() {
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

  await db.sessions
    .where('createdAt')
    .below(thirtyDaysAgo.toISOString())
    .delete();
}

// 应用启动时执行清理
if (typeof window !== 'undefined') {
  cleanupOldSessions();
}
```

### 6.2 会话 CRUD

```typescript
// src/lib/db/sessions.ts
import { db } from './index';
import { Session, SessionSchema } from '@/lib/schemas';
import { nanoid } from 'nanoid';

export async function createSession(): Promise<string> {
  const id = nanoid();
  const session: Session = {
    id,
    stage: 'calm_down',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
  };
  await db.sessions.add(session);
  return id;
}

export async function getSession(id: string): Promise<Session | undefined> {
  return db.sessions.get(id);
}

export async function updateSession(id: string, updates: Partial<Session>): Promise<void> {
  await db.sessions.update(id, {
    ...updates,
    updatedAt: new Date().toISOString(),
  });
}

export async function deleteSession(id: string): Promise<void> {
  await db.sessions.delete(id);
}

export async function getAllSessions(): Promise<Session[]> {
  return db.sessions.orderBy('updatedAt').reverse().toArray();
}
```

---

## 7. 安全策略实现

### 7.1 安全资源缓存

```typescript
// src/lib/constants/safety-resources.ts
export const SAFETY_RESOURCES = {
  hotlines: [
    { name: '全国心理援助热线', number: '400-161-9995' },
    { name: '妇女维权热线', number: '12338' },
    { name: '紧急报警', number: '110' },
  ],
};

// 应用启动时缓存到 localStorage
if (typeof window !== 'undefined') {
  localStorage.setItem('safety_resources', JSON.stringify(SAFETY_RESOURCES));
}

export function getSafetyResources() {
  if (typeof window === 'undefined') return SAFETY_RESOURCES;
  try {
    const cached = localStorage.getItem('safety_resources');
    return cached ? JSON.parse(cached) : SAFETY_RESOURCES;
  } catch {
    return SAFETY_RESOURCES;
  }
}
```

### 7.2 安全屏幕组件

```typescript
// src/components/safety/safety-screen.tsx
'use client';

import { useRouter } from 'next/navigation';
import { getSafetyResources } from '@/lib/constants/safety-resources';

interface SafetyScreenProps {
  concern?: string;
}

export function SafetyScreen({ concern }: SafetyScreenProps) {
  const router = useRouter();
  const resources = getSafetyResources();

  return (
    <div className="min-h-screen flex items-center justify-center bg-white p-8">
      <div className="max-w-md text-center space-y-6">
        <h1 className="text-2xl font-semibold text-gray-900">
          你的安全是最重要的
        </h1>

        <p className="text-gray-600">
          如果你正在经历或担心人身安全问题，请寻求专业帮助：
        </p>

        <div className="space-y-3">
          {resources.hotlines.map((hotline) => (
            <a
              key={hotline.number}
              href={`tel:${hotline.number}`}
              className="block p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
            >
              <div className="font-medium">{hotline.name}</div>
              <div className="text-lg text-blue-600">{hotline.number}</div>
            </a>
          ))}
        </div>

        <div className="flex gap-4 justify-center pt-4">
          <button
            onClick={() => router.push('/')}
            className="px-6 py-2 bg-gray-100 rounded-lg hover:bg-gray-200"
          >
            退出
          </button>
          <button
            onClick={() => window.history.back()}
            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            我现在安全
          </button>
        </div>
      </div>
    </div>
  );
}
```

### 7.3 全局安全按钮

```typescript
// src/components/layout/global-safety-button.tsx
'use client';

import { useState } from 'react';
import { SafetyResourcesDialog } from '@/components/safety/safety-resources';

export function GlobalSafetyButton() {
  const [showResources, setShowResources] = useState(false);

  return (
    <>
      <button
        onClick={() => setShowResources(true)}
        className="fixed bottom-4 right-4 text-sm text-gray-500 hover:text-gray-700
                   bg-white/80 backdrop-blur px-3 py-1.5 rounded-full shadow-sm"
      >
        需要帮助？
      </button>
      <SafetyResourcesDialog
        open={showResources}
        onClose={() => setShowResources(false)}
      />
    </>
  );
}
```

---

## 8. AI Prompts

### 8.1 System Prompt

```typescript
// src/lib/ai/prompts.ts
export const SYSTEM_PROMPT = `你是一位温和、好奇、不评判的陪伴者。你的角色不是裁判，而是帮助用户理解自己和对方。

## 核心信念
- "世上并没有坏人，只有受苦的人。"
- "别把这看作是针对你的。"
- "先假设对方是善意的，除非有证据证明不是。"

## 你的任务
1. **安全评估优先**：如果存在人身威胁或自伤信号，立即标记 safety.level = 'danger'
2. **逐条消息分析**：为每条消息提供双视角解读（myPerspective + theirPerspective）
3. **精选关键时刻**：从消息中选出最重要的2-3个转折点
4. **误区框架应用**：选择1-2个最相关的四大误区进行解读
5. **生成理解话术**：帮助用户"表达理解"而非"解释自己"

## 四大认知误区框架
1. 反对不等于针对：当对方反对时，不是针对我，是在保护自己的利益
2. 威胁源于恐惧：当对方威胁时，不是想吓我，是自己正在恐惧
3. 批评源于痛苦：当对方批评时，不是想伤害我，是自己正在痛苦
4. 轻蔑源于自卑：当对方轻蔑时，不是看不起我，是看不起自己

## 语言要求
- 永远使用"可能"、"也许"、"一个角度是"等非断言性语言
- 避免"应该"、"必须"、"错误"等评判性语言
- 分析"我"的言行时同样保持善意假设
- 书中引用要准确，使用原文

## 安全检测指南
识别以下信号时，将 safety.level 设为 'danger'：
- 人身伤害威胁（明确的打、杀、伤害意图）
- 自伤/自杀信号
- 严重的精神控制描述

识别以下信号时，将 safety.level 设为 'caution'：
- 持续性冷暴力
- 反复的威胁性语言
- 经济控制或社交隔离描述

## 输出要求
- messages 数组长度应与输入消息数量一致
- 每条消息必须包含 myPerspective 和 theirPerspective 双视角
- keyMoments 通过 messageIndex 关联到 messages
- insights 最多2个，选择最相关的误区框架`;

export function formatPrompt(input: DialogueInput): string {
  const messagesText = input.messages
    .map((m, i) => `[${i}] ${m.speaker}：${m.text}`)
    .join('\n');

  return `请分析以下对话中的冲突：

## 对话内容
${messagesText}

${input.context ? `## 用户补充背景\n${input.context}` : ''}

请按照 schema 结构返回分析结果。注意：
1. safety 评估是最高优先级，必须首先输出
2. messages 数组应包含对每条消息的分析，每条消息都需要同时提供 myPerspective 和 theirPerspective
3. keyMoments 通过 messageIndex 关联到 messages
4. insights 最多选择2个最相关的误区框架
5. reconnection.sampleScript 要自然、可直接使用`;
}
```

---

## 9. 页面路由与导航

### 9.1 阶段流转逻辑

```typescript
// src/lib/utils/stage-navigation.ts
import { Session } from '@/lib/schemas';

export const STAGE_ORDER = [
  'calm_down',
  'input',
  'analyzing',
  'review',
  'insights',
  'reconnect',
  'export',
  'complete',
] as const;

export function getNextStage(current: Session['stage']): Session['stage'] | null {
  if (current === 'paused') return null;
  const currentIndex = STAGE_ORDER.indexOf(current);
  if (currentIndex === -1 || currentIndex >= STAGE_ORDER.length - 1) return null;
  return STAGE_ORDER[currentIndex + 1];
}

export function canGoToStage(
  current: Session['stage'],
  target: Session['stage'],
  session: Session
): boolean {
  // 已完成的阶段可以回看
  const currentIndex = STAGE_ORDER.indexOf(current);
  const targetIndex = STAGE_ORDER.indexOf(target);

  // 不能跳过阶段
  if (targetIndex > currentIndex + 1) return false;

  // 特殊检查：必须完成情绪自检才能进入下一步
  if (target !== 'calm_down' && !session.emotionCheckIn?.readyToProceed) {
    return false;
  }

  return true;
}

export function getStageUrl(sessionId: string, stage: Session['stage']): string {
  const stageToPath: Record<string, string> = {
    calm_down: 'calm-down',
    input: 'input',
    analyzing: 'review',
    review: 'review',
    insights: 'insights',
    reconnect: 'reconnect',
    export: 'export',
  };
  return `/session/${sessionId}/${stageToPath[stage] || ''}`;
}
```

### 9.2 阶段进度组件

```typescript
// src/components/layout/stage-progress.tsx
'use client';

import { cn } from '@/lib/utils/cn';
import { Session } from '@/lib/schemas';

const STAGES = [
  { key: 'calm_down', label: '平复自己' },
  { key: 'review', label: '理解双方' },
  { key: 'insights', label: '视角转换' },
  { key: 'reconnect', label: '重建连接' },
];

interface StageProgressProps {
  currentStage: Session['stage'];
}

export function StageProgress({ currentStage }: StageProgressProps) {
  const currentIndex = STAGES.findIndex(s => s.key === currentStage);

  return (
    <div className="flex items-center justify-center gap-2 py-4">
      {STAGES.map((stage, index) => (
        <div key={stage.key} className="flex items-center">
          <div
            className={cn(
              'w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium',
              index < currentIndex && 'bg-green-100 text-green-700',
              index === currentIndex && 'bg-blue-600 text-white',
              index > currentIndex && 'bg-gray-100 text-gray-400'
            )}
          >
            {index + 1}
          </div>
          <span
            className={cn(
              'ml-2 text-sm hidden sm:inline',
              index === currentIndex ? 'text-gray-900 font-medium' : 'text-gray-500'
            )}
          >
            {stage.label}
          </span>
          {index < STAGES.length - 1 && (
            <div
              className={cn(
                'w-8 h-0.5 mx-2',
                index < currentIndex ? 'bg-green-300' : 'bg-gray-200'
              )}
            />
          )}
        </div>
      ))}
    </div>
  );
}
```

---

## 10. PDF 导出

```typescript
// src/lib/utils/export-pdf.ts
import { PDFDocument, StandardFonts, rgb } from 'pdf-lib';
import { Session, ConflictAnalysis } from '@/lib/schemas';

export async function exportSessionToPDF(session: Session): Promise<Uint8Array> {
  const pdfDoc = await PDFDocument.create();
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

  let page = pdfDoc.addPage();
  const { width, height } = page.getSize();
  let y = height - 50;

  const drawText = (text: string, size = 12, color = rgb(0, 0, 0)) => {
    if (y < 50) {
      page = pdfDoc.addPage();
      y = height - 50;
    }
    page.drawText(text, { x: 50, y, size, font, color });
    y -= size + 8;
  };

  // 标题
  drawText('Conflict Archaeology - 冲突分析报告', 20);
  drawText(`生成时间：${new Date().toLocaleString('zh-CN')}`, 10, rgb(0.5, 0.5, 0.5));
  y -= 20;

  if (session.analysis) {
    const { overview, perspectives, keyMoments, insights, reconnection } = session.analysis;

    // 概览
    drawText('【冲突概览】', 14);
    drawText(overview.oneLiner);
    y -= 10;

    // 双方视角
    drawText('【我的视角】', 14);
    drawText(`情绪：${perspectives.mine.surfaceEmotion}`);
    drawText(`担忧：${perspectives.mine.underlyingFear}`);
    drawText(`需求：${perspectives.mine.unmetNeed}`);
    y -= 10;

    drawText('【TA的视角】', 14);
    drawText(`情绪：${perspectives.theirs.surfaceEmotion}`);
    drawText(`担忧：${perspectives.theirs.underlyingFear}`);
    drawText(`需求：${perspectives.theirs.unmetNeed}`);
    y -= 10;

    // 关键时刻
    if (keyMoments.length > 0) {
      drawText('【关键时刻】', 14);
      keyMoments.forEach((moment, i) => {
        drawText(`${i + 1}. "${moment.quote}"`);
        drawText(`   ${moment.significance}`, 10, rgb(0.3, 0.3, 0.3));
      });
      y -= 10;
    }

    // 误区洞察
    if (insights.length > 0) {
      drawText('【视角转换】', 14);
      insights.forEach((insight) => {
        drawText(`类型：${insight.type}`);
        drawText(`你可能以为：${insight.youMightThink}`);
        drawText(`另一个可能：${insight.alternativeView}`);
        drawText(`书中智慧：${insight.bookQuote}`, 10, rgb(0.3, 0.3, 0.3));
        y -= 5;
      });
      y -= 10;
    }

    // 重建连接
    drawText('【理解表达】', 14);
    drawText(reconnection.coreUnderstanding);
    y -= 10;
    drawText('【对话示例】', 14);
    drawText(reconnection.sampleScript, 11);
  }

  return pdfDoc.save();
}
```

---

## 11. 环境变量配置

```bash
# .env.local
OPENAI_API_KEY=sk-xxx

# 可选：使用其他模型
# ANTHROPIC_API_KEY=xxx
```

---

## 12. 性能优化

### 12.1 流式渲染优化

```typescript
// 使用 React Suspense 和流式边界
import { Suspense } from 'react';

function AnalysisPage() {
  return (
    <Suspense fallback={<LoadingSkeleton />}>
      <AnalysisView />
    </Suspense>
  );
}
```

### 12.2 图片压缩

```typescript
// src/lib/utils/image.ts
export async function compressImage(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();

    img.onload = () => {
      // 限制最大尺寸为 1024px
      const maxSize = 1024;
      let { width, height } = img;

      if (width > maxSize || height > maxSize) {
        const ratio = Math.min(maxSize / width, maxSize / height);
        width *= ratio;
        height *= ratio;
      }

      canvas.width = width;
      canvas.height = height;
      ctx?.drawImage(img, 0, 0, width, height);

      // 转换为 base64，质量 0.8
      resolve(canvas.toDataURL('image/jpeg', 0.8));
    };

    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}
```

---

## 13. 测试策略

| 测试类型 | 工具 | 覆盖范围 |
|---|---|---|
| 单元测试 | Vitest | Schema 验证、工具函数 |
| 组件测试 | Testing Library | 关键 UI 组件 |
| E2E 测试 | Playwright | 核心用户流程 |
| 可访问性 | axe-core | WCAG 2.1 AA |

---

## 14. 部署方案

### 14.1 Vercel 部署（推荐）

```json
// vercel.json
{
  "functions": {
    "src/app/api/analyze/route.ts": {
      "maxDuration": 60
    }
  }
}
```

### 14.2 环境配置

| 环境 | 用途 | API 配置 |
|---|---|---|
| Development | 本地开发 | 开发密钥，无速率限制 |
| Preview | PR 预览 | 测试密钥，有速率限制 |
| Production | 生产环境 | 生产密钥，完整监控 |

---

## 15. 后续迭代

| 优先级 | 功能 | 技术方案 |
|---|---|---|
| P1 | 情绪曲线可视化 | Recharts + 自定义 tooltip |
| P1 | 历史记录管理 | IndexedDB 分页查询 |
| P2 | 模拟对话练习 | streamText + 角色扮演 prompt |
| P2 | 多语言支持 | next-intl |
| P3 | 协作功能 | 需要后端数据库支持 |
