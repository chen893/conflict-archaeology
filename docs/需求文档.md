# Conflict Archaeology 需求文档（v2.0）

## 版本信息
|版本|日期|主要更新|
|---|---|---|
|v2.0|2024-05-09|以产品经理视角重新审视需求：补齐产品摘要/北极星、体验蓝图、MoSCoW 功能分级、AI SDK Core 工作流、指标与风险，沉淀 v2 方向|
|v1.1|2024-05-06|重构文档结构，纳入《我就是你啊》修炼要点、VR Reframe + 修复闭环、AI SDK Core/UI 技术方案、安全模式与页面划分|
|v1.0|2024-04-12|首次提出“first_fossil”概念与时间线考古体验|

## 1. 产品摘要
- **使命**：让陷入冲突的亲密关系在 10 分钟内获得“冷静 + 共情 + 行动”三段式指引，把冲突当成考古，而不是拉锯战。



## 2. 背景洞察（Conflict Insights）
1. 《我就是你啊》指出“威胁只会唤醒对方的恐惧”，然而用户在争执后普遍会经历“解释→威胁→辱骂”的加速度；我们需要在 timeline 中提早暴露恐惧的起点。
2. 访谈中 80% 的用户已习惯截图/导出聊天记录，但难以判断哪一句才是真正的裂缝（first_fossil），导致复盘效率低。
3. 现有伴侣沟通产品重内容建议，缺少“情绪考古”过程；AI SDK Core 提供的多模态流式与工具能力能够支持动态 timeline、风险雷达与修复计划。
4. 用户担忧“被评判”或“再次被 gaslight”，因此体验必须贯彻“冷静、好奇、不评判”的文案与交互。

## 3. 用户画像与 JTBD
|Persona|痛点|JTBD（Job Statement）|衡量|
|---|---|---|---|
|长期关系中的伴侣（核心）|争执后脑海混乱，不知如何重新开口|“当我与伴侣争吵失控时，我想弄清是谁先被触发，以及我可以怎么修复关系”|能在 15 分钟内拿到 3 条可执行行动|
|跨地域/远程团队合伙人|缺少同步沟通时间，希望快速定位误解|“当远程合作出现误解时，我需要一个工具帮我看到对方真实担忧”|timeline 中清晰定位 first_fossil，并生成为文本/PDF|
|HR/组织教练（次要）|干预冲突时信息不对称|“当员工求助时，我需要复盘关键节点并输出建议”|可导出匿名化报告并回看历史案例|

## 4. 体验目标与设计原则
- **双冷静曲线**：系统默认“先平复自己的情绪，再理解对方”，UI 中任何提醒先提示“我们先停一停”。
- **先理解后建议**：Timeline、VR Reframe 放在行动建议之前，呼应书中“先假设对方是善意的”。
- **多模态可信度**：图片 + 文本同框展示，并提供引用高亮，减少“AI 凭空编造”的质疑。
- **可撤退性**：每个页面都给出“离开/稍后继续”的提示，尊重用户情绪边界。

## 5. 体验蓝图（Journey Blueprint）
|阶段|关键问题|系统责任|关键触点/页面|
|---|---|---|---|
|1. 情绪降噪|“我现在很乱，能帮我重置吗？”|用书中金句+安全提醒让用户暂时从愤怒切回好奇|Landing + 安全声明|
|2. 素材收集|“这段对话够用吗？”|指导用户上传最关键的文本/截图并校验质量|Upload & Context|
|3. 情绪考古|“真正的裂缝在哪？”|用 timeline + 风险雷达指出 first_fossil、沉默、威胁|Timeline Overview|
|4. 视角切换|“TA 可能在害怕什么？”|通过 VR Reframe 让用户体验“我/TA/System”叙事|VR Reframe 页|
|5. 修复闭环|“我下一步该怎么说/做？”|提供共情摘要、归因、3 条行动和话术，必要时进入安全模式|Repair Plan 页|
|6. 沉淀与学习|“我想保存/下次参考”|导出 PDF、记录反馈、回看历史，并设置提醒|Export & Library|

> 页面 2-6 共享顶部 Stepper 与“随时离开，情绪允许时再回来”的提示；时间线/VR/修复页共享三列布局（左原文、中洞察、右情绪）。

## 6. 功能需求（MoSCoW）
|级别|需求|描述|验收要点|
|---|---|---|---|
|Must|first_fossil 自动识别|LLM 基于多模态输入输出首个裂缝节点及理由|命中率 ≥80%，给出原句引用和 reasoning|
|Must|风险等级与安全模式|根据语言暴力/恐吓/求助信号动态给出 Level 1-3，并在 Level 3 进入安全模式|安全模式时只显示求助信息，不展示行动建议|
|Must|修复计划四件套|共情摘要（≤80 字）、归因、三条行动建议、回复模板|行动建议包含 actionType、耗时、渠道、适用风险|
|Must|PDF/文本导出|文档中包含时间线截图、修复计划、安全信息|导出成功率 ≥ 98%|
|Should|VR Reframe 收藏与自定义反思|允许用户保存触动句子并写下个人洞察|本地 IndexedDB 持久化|
|Should|素材质量提示|检测长文本或模糊截图并给出建议|≤2 秒内完成校验|
|Could|情绪折线回放|按时间展示双方情绪曲线，支持 hover 查看原文|可切换“只看我/只看 TA/合并”|
|Won’t (v2)|多人实时协作|—|后续评估|

## 7. AI 策略（AI SDK Core + UI）
1. **模型与路由**：默认 `gpt-4o`，通过 `providerOptions` 兼容 Azure；未来可引入 `anthropic/claude` 以比较威胁识别效果。
2. **多模态输入**：上传图片先经前端压缩，随后以 `messages[].content[{type:'image'}]` 形式传递；保留 URL 以便模型引用。
3. **Prompt 架构**：
   - `system`：设定“冷静、好奇、不评判”的考古师人格，引用书中三大误区提醒模型不要妄下结论。
   - `messages`：包含原始对话、用户补充背景、情绪自评。
   - `streamObject`：调用 `AnalysisResultSchema`，temperature=0，保证结构化与可预测性。
4. **工具**：
   - `summarizeSilence`：解释沉默/单字回复。
   - `detectThreat`：匹配威胁语言和 Level 3 线索。
   - `rewriteReply`：生成高情商话术。
   - 若工具 schema 复杂，使用 `experimental_repairToolCall` 结合更强模型进行修补。
5. **流式体验**：
   - `streamText` 渲染时间线/VR Reframe 逐句更新。
   - `ai-sdk-ui/useChat` + `convertToModelMessages` 管理 UI message。
   - `onAbort` 钩子记录“用户中途休息”，并在下一次进入时提示“继续考古或重新开始”。
6. **错误与监控**：捕获 `NoSuchToolError`/`InvalidToolInputError`/`ToolCallRepairError`，日志中保留 `result.warnings` 与 `request.body` hash；若图片解析失败，引导用户手动输入文字。

## 8. 数据模型与接口
```ts
import { z } from 'zod';

const EmotionEnum = z.enum(['平静', '焦虑', '委屈', '愤怒', '冷漠', '失望']);
const SpeakerEnum = z.enum(['我', 'TA', 'System']);
const SegmentTypeEnum = z.enum(['first_fossil', 'divergence', 'escalation', 'trigger', 'cooling']);
const RiskLevelEnum = z.enum(['1', '2', '3']);
const JourneyStageEnum = z.enum(['intake', 'timeline', 'reframe', 'repair', 'export']);

const MessageAnalysisSchema = z.object({
  originalText: z.string(),
  speaker: SpeakerEnum,
  emotion: EmotionEnum,
  latentNeed: z.string().describe('未说出口的真实需求或恐惧'),
  riskLevel: RiskLevelEnum.optional(),
  isSilenceOrBrief: z.boolean(),
  silenceInterpretation: z.string().optional(),
});

const TimelineNodeSchema = z.object({
  id: z.string(),
  messageIndex: z.number(),
  type: SegmentTypeEnum,
  summary: z.string(),
  reasoning: z.string(),
  quote: z.string().optional(),
});

const RepairActionSchema = z.object({
  title: z.string(),
  actionType: z.enum(['道歉', '自我披露', '需求澄清', '具体行动', '求助外援']),
  detail: z.string(),
  expectedOutcome: z.string(),
  effortMinutes: z.number().int().min(0),
  channel: z.enum(['face_to_face', 'call', 'text']),
  applicableRiskLevels: z.array(RiskLevelEnum).min(1),
});

const RepairPlanSchema = z.object({
  empathySummary: z.string(),
  rootCause: z.string(),
  firstFossilRef: z.string(),
  actions: z.array(RepairActionSchema).length(3),
  replyTemplate: z.string(),
  safetyNote: z.string().optional(),
});

const PageSessionSchema = z.object({
  stage: JourneyStageEnum,
  enterAt: z.string(),
  leaveAt: z.string(),
  sentimentBefore: EmotionEnum,
  sentimentAfter: EmotionEnum,
});

export const AnalysisResultSchema = z.object({
  title: z.string().describe('考古记录式标题'),
  timeline: z.array(TimelineNodeSchema),
  messageAnalyses: z.array(MessageAnalysisSchema),
  repairPlan: RepairPlanSchema,
  pageSessions: z.array(PageSessionSchema).min(1),
  criticalSafetyWarning: z.boolean(),
});
```

- **API 输出**：`/api/analyze` 返回 `AnalysisResultSchema`；`/api/export` 接收 AnalysisResult + 用户偏好生成 PDF；`/api/feedback` 写入帮助度评分。

## 9. 指标体系与实验假设
|层级|指标|目标|数据来源|
|---|---|---|---|
|激活|first_fossil 命中后继续到 VR Reframe 的转化率|≥ 70%|页面埋点 + pageSessions|
|参与度|VR Reframe 收藏率 / 自定义反思填写率|≥ 40%|IndexedDB + 埋点|
|安全|高危会话求助提示曝光时长|≥ 15s|前端埋点|
|满意度|“有帮助”占比|≥ 65%|反馈表单|

- **实验假设**：
  1. 若先呈现“冷静提醒 + first_fossil”再给行动建议，用户更愿意导出（H1）。
  2. VR Reframe 收藏功能可提高再次使用率（H2）。
  3. 在导出前插入“共情摘要确认”步骤可降低行动建议被判定为“太激烈”的比率（H3）。

## 10. 技术架构
- **前端**：Next.js App Router，Tailwind v4，Framer Motion（VR Reframe 动效），Lucide 图标；全局样式位于 `src/styles/globals.css`。
- **AI 层**：`ai` SDK Core/UI，`src/env.js` 统一校验模型与密钥；工具函数拆分在 `src/lib/tools`。
- **数据与存储**：IndexedDB（Dexie）缓存最近 5 次 Analysis；localStorage 存放偏好；无服务器端数据库（MVP）。
- **导出**：`pdf-lib` 生成“情绪考古报告”，新增修复计划、安全提示页。

## 11. 安全、隐私与合规
1. 首屏必须展示“AI 仅供参考”与《我就是你啊》关于避免暴力的提示。
2. `criticalSafetyWarning=true` 时，立即终止所有分析显示，覆盖求助热线并提示“请先恢复安全再继续”。
3. 输入数据默认只保留在本地
4. 新增环境变量需同步 `.env.example` 并禁止写入仓库密钥。
5. 图片/文本渲染时避免缓存到公共 CDN，使用浏览器内存 URL。

## 12. 项目计划
|阶段|范围|时间|里程碑|
|---|---|---|---|
|Phase 1（MVP）|输入+时间线+修复计划+导出|~4 周|完成 `pnpm check/lint/format`，上线灰度|
|Phase 2（Visuals）|多图排序、VR Reframe 动效、IndexedDB 档案库|~3 周|VR Reframe 收藏功能上线|
|Phase 3（Advanced）|多轮追问、专家模式|~4 周|问答实验启动|

## 13. 风险、依赖与开放问题
|类别|内容|缓解方案|
|---|---|---|
|模型准确度|first_fossil 判断错误导致体验崩溃|引入用户校正入口，允许“重新定位 first_fossil”并回写数据|
|安全合规|Level 3 未被识别|在 `detectThreat` 工具外，再加本地关键词黑名单；必要时人工审核|
|性能|多图 + 长文本超出 token|前端压缩 + 分片处理 + 提示用户聚焦关键片段|
|依赖|PDF 生成与字体支持|预置思源黑体子集，避免导出缺字|
|开放问题|是否要引入情绪呼吸引导/音频教学？|待 Phase 2 用户访谈后决定|

---
- 所有命令、构建前需执行 `pnpm check` + `pnpm lint` + `pnpm format:check`，提交遵循 Conventional Commits。
- UI 变更需提供前/后截图或短视频；AI 功能参考 `ai-sdk-core.md` 与 `ai-sdk-ui.md`。
