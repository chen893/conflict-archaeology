# Conflict Archaeology 实施计划

## 1. 项目概述

**产品使命**：帮助陷入冲突的人在 15 分钟内完成「平复自己 → 理解对方 → 重建连接」的完整旅程。

**核心流程**：
```
[Landing] → [1. 平复自己] → [2. 输入对话] → [AI分析] → [3. 理解双方] → [4. 视角转换] → [5. 重建连接] → [导出]
```

---

## 2. 当前状态评估

| 维度 | 完成度 | 说明 |
|------|--------|------|
| 框架配置 | 100% | Next.js 15 App Router, Tailwind CSS v4, TypeScript 5 |
| 依赖安装 | 100% | ai, dexie, framer-motion, pdf-lib, zod 等已配置 |
| 文档规划 | 100% | 需求描述v2.md + 技术方案.md 完整 |
| 业务代码 | 0% | 仅 T3 Stack 默认模板 |
| API 端点 | 0% | /api/analyze 未实现 |
| 数据库 | 0% | IndexedDB 未初始化 |

---

## 3. 开发阶段规划

### Phase 1: 基础设施层

**目标**：搭建核心工具库，为业务层提供支撑

#### 1.1 Zod Schemas（Must）

| 文件 | 内容 | 依赖 |
|------|------|------|
| `src/lib/schemas/index.ts` | 统一导出 | - |
| `src/lib/schemas/emotion.ts` | EmotionCheckInSchema | - |
| `src/lib/schemas/dialogue.ts` | DialogueInputSchema, MessageSchema | - |
| `src/lib/schemas/analysis.ts` | ConflictAnalysisSchema, MessageInsightSchema, PerspectiveSchema | - |
| `src/lib/schemas/session.ts` | SessionSchema, SavedInsightSchema | emotion, dialogue, analysis |

#### 1.2 常量定义（Must）

| 文件 | 内容 |
|------|------|
| `src/lib/constants/emotions.ts` | 情绪选项列表（愤怒/委屈/焦虑/失望/冷漠/混乱/其他） |
| `src/lib/constants/safety-resources.ts` | 求助热线信息 + localStorage 缓存逻辑 |
| `src/lib/constants/book-quotes.ts` | 《我就是你啊》书中金句 |

#### 1.3 工具函数（Must）

| 文件 | 内容 |
|------|------|
| `src/lib/utils/cn.ts` | clsx + tailwind-merge 封装 |
| `src/lib/utils/stage-navigation.ts` | 阶段流转逻辑（STAGE_ORDER, getNextStage, canGoToStage, getStageUrl） |

#### 1.4 数据库层（Must）

| 文件 | 内容 |
|------|------|
| `src/lib/db/index.ts` | Dexie 数据库类定义 + 自动清理 30 天数据 |
| `src/lib/db/sessions.ts` | createSession, getSession, updateSession, deleteSession, getAllSessions |
| `src/lib/db/insights.ts` | 洞察收藏 CRUD |

#### 1.5 React Hooks（Must）

| 文件 | 内容 |
|------|------|
| `src/hooks/use-is-mobile.ts` | 响应式检测 (< 1024px) |
| `src/hooks/use-local-storage.ts` | localStorage 读写 hook |

---

### Phase 2: 核心流程

**目标**：实现用户从进入到提交对话的完整路径

#### 2.1 会话上下文（Must）

| 文件 | 内容 |
|------|------|
| `src/contexts/session-context.tsx` | SessionProvider + useSession hook |

#### 2.2 基础 UI 组件（Must）

| 文件 | 说明 |
|------|------|
| `src/components/ui/button.tsx` | 按钮组件（variants: default, outline, ghost） |
| `src/components/ui/card.tsx` | 卡片容器 |
| `src/components/ui/input.tsx` | 文本输入框 |
| `src/components/ui/textarea.tsx` | 多行文本框 |
| `src/components/ui/dialog.tsx` | 对话框 |

#### 2.3 布局组件（Must）

| 文件 | 内容 |
|------|------|
| `src/components/layout/header.tsx` | 顶部导航（logo + 暂停按钮） |
| `src/components/layout/stage-progress.tsx` | 四阶段进度条 |
| `src/components/layout/global-safety-button.tsx` | 固定在右下角的「需要帮助？」按钮 |

#### 2.4 Landing 页面（Must）

| 文件 | 内容 |
|------|------|
| `src/app/page.tsx` | 重写为产品首页：使命说明 + 「开始」按钮 + 安全声明 |

#### 2.5 阶段 1：平复自己（Must）

| 文件 | 内容 |
|------|------|
| `src/app/session/[id]/page.tsx` | 会话路由分发 + SessionProvider 包裹 |
| `src/app/session/[id]/calm-down/page.tsx` | 平复自己页面容器 |
| `src/components/calm-down/emotion-check-in.tsx` | 情绪选择器（单选 + 强度滑块） |
| `src/components/calm-down/breathing-guide.tsx` | 深呼吸引导动画（Should） |
| `src/components/calm-down/wisdom-quote.tsx` | 随机书中金句展示 |
| `src/components/calm-down/readiness-confirm.tsx` | 「准备好了」确认按钮 |

#### 2.6 阶段 2：输入对话（Must）

| 文件 | 内容 |
|------|------|
| `src/app/session/[id]/input/page.tsx` | 对话输入页面 |
| `src/components/dialogue/message-input.tsx` | 单条消息输入（speaker 切换 + text） |
| `src/components/dialogue/message-list.tsx` | 消息列表展示 + 删除/编辑 |
| `src/components/dialogue/context-input.tsx` | 背景信息输入框 |
| `src/components/dialogue/image-upload.tsx` | 截图上传组件（Should） |

#### 2.7 AI 分析 API（Must）

| 文件 | 内容 |
|------|------|
| `src/lib/ai/config.ts` | OpenAI 模型配置 |
| `src/lib/ai/prompts.ts` | SYSTEM_PROMPT + formatPrompt |
| `src/lib/ai/analyze.ts` | analyzeConflict 函数封装 |
| `src/app/api/analyze/route.ts` | POST 端点：streamObject + ConflictAnalysisSchema |

---

### Phase 3: 分析展示

**目标**：实现 AI 分析结果的流式渲染和交互

#### 3.1 分析结果组件（Must）

| 文件 | 内容 |
|------|------|
| `src/app/session/[id]/review/page.tsx` | 理解双方页面 |
| `src/components/analysis/analysis-view.tsx` | 流式渲染容器（useObject） |
| `src/components/analysis/overview-section.tsx` | 冲突概览（oneLiner + escalationPattern） |
| `src/components/analysis/timeline-section.tsx` | 消息时间线 |
| `src/components/analysis/message-item.tsx` | 单条消息 + 双视角展示（响应式） |
| `src/components/analysis/perspectives-section.tsx` | 双方视角汇总 |
| `src/components/analysis/key-moments-section.tsx` | 关键时刻卡片 |

#### 3.2 视角转换组件（Must）

| 文件 | 内容 |
|------|------|
| `src/app/session/[id]/insights/page.tsx` | 视角转换页面 |
| `src/components/insights/insight-card.tsx` | 误区洞察卡片 |
| `src/components/insights/misconception-frame.tsx` | 四大误区框架展示 |
| `src/components/insights/insight-saver.tsx` | 「保存到洞察库」按钮 |

#### 3.3 重建连接组件（Must）

| 文件 | 内容 |
|------|------|
| `src/app/session/[id]/reconnect/page.tsx` | 重建连接页面 |
| `src/components/reconnect/understanding-template.tsx` | 理解表达模板（可编辑） |
| `src/components/reconnect/opening-suggestions.tsx` | 开场白建议列表 |
| `src/components/reconnect/timing-advice.tsx` | 时机建议提示 |

#### 3.4 安全组件（Must）

| 文件 | 内容 |
|------|------|
| `src/components/safety/safety-screen.tsx` | 危险级别全屏阻断 |
| `src/components/safety/caution-banner.tsx` | 警告级别底部横幅 |
| `src/components/safety/safety-resources.tsx` | 求助资源对话框 |
| `src/components/safety/loading-with-safety-hint.tsx` | 加载中 + 安全提示 |

---

### Phase 4: 体验完善

**目标**：完成 MVP 剩余功能和体验优化

#### 4.1 导出功能（Should）

| 文件 | 内容 |
|------|------|
| `src/app/session/[id]/export/page.tsx` | 导出页面 |
| `src/lib/utils/export-pdf.ts` | PDF 生成逻辑（pdf-lib） |

#### 4.2 暂停与恢复（Should）

| 文件 | 内容 |
|------|------|
| `src/app/paused/page.tsx` | 暂停页面 + 继续/重新开始选项 |

#### 4.3 图片压缩（Should）

| 文件 | 内容 |
|------|------|
| `src/lib/utils/image.ts` | compressImage 函数（Canvas 压缩到 1024px） |

#### 4.4 情绪曲线（Could）

| 文件 | 内容 |
|------|------|
| `src/components/analysis/emotion-curve.tsx` | 双方情绪随时间变化的可视化 |

#### 4.5 历史记录（Could）

| 文件 | 内容 |
|------|------|
| `src/app/history/page.tsx` | 历史会话列表 |
| `src/hooks/use-session.ts` | 会话状态管理增强 |

---

## 4. 任务清单（按执行顺序）

### Phase 1 任务（共 12 个文件）

```
□ src/lib/utils/cn.ts
□ src/lib/schemas/emotion.ts
□ src/lib/schemas/dialogue.ts
□ src/lib/schemas/analysis.ts
□ src/lib/schemas/session.ts
□ src/lib/schemas/index.ts
□ src/lib/constants/emotions.ts
□ src/lib/constants/safety-resources.ts
□ src/lib/constants/book-quotes.ts
□ src/lib/utils/stage-navigation.ts
□ src/lib/db/index.ts
□ src/lib/db/sessions.ts
```

### Phase 2 任务（共 21 个文件）

```
□ src/hooks/use-is-mobile.ts
□ src/hooks/use-local-storage.ts
□ src/contexts/session-context.tsx
□ src/components/ui/button.tsx
□ src/components/ui/card.tsx
□ src/components/ui/input.tsx
□ src/components/ui/textarea.tsx
□ src/components/ui/dialog.tsx
□ src/components/layout/header.tsx
□ src/components/layout/stage-progress.tsx
□ src/components/layout/global-safety-button.tsx
□ src/app/page.tsx (重写)
□ src/app/session/[id]/page.tsx
□ src/app/session/[id]/calm-down/page.tsx
□ src/components/calm-down/emotion-check-in.tsx
□ src/components/calm-down/wisdom-quote.tsx
□ src/components/calm-down/readiness-confirm.tsx
□ src/app/session/[id]/input/page.tsx
□ src/components/dialogue/message-input.tsx
□ src/components/dialogue/message-list.tsx
□ src/components/dialogue/context-input.tsx
```

### Phase 3 任务（共 18 个文件）

```
□ src/lib/ai/config.ts
□ src/lib/ai/prompts.ts
□ src/lib/ai/analyze.ts
□ src/app/api/analyze/route.ts
□ src/app/session/[id]/review/page.tsx
□ src/components/analysis/analysis-view.tsx
□ src/components/analysis/overview-section.tsx
□ src/components/analysis/timeline-section.tsx
□ src/components/analysis/message-item.tsx
□ src/components/analysis/perspectives-section.tsx
□ src/components/analysis/key-moments-section.tsx
□ src/app/session/[id]/insights/page.tsx
□ src/components/insights/insight-card.tsx
□ src/components/insights/misconception-frame.tsx
□ src/app/session/[id]/reconnect/page.tsx
□ src/components/reconnect/understanding-template.tsx
□ src/components/reconnect/opening-suggestions.tsx
□ src/components/reconnect/timing-advice.tsx
```

### Phase 4 任务（共 8 个文件）

```
□ src/components/safety/safety-screen.tsx
□ src/components/safety/caution-banner.tsx
□ src/components/safety/safety-resources.tsx
□ src/components/safety/loading-with-safety-hint.tsx
□ src/app/session/[id]/export/page.tsx
□ src/lib/utils/export-pdf.ts
□ src/app/paused/page.tsx
□ src/lib/db/insights.ts
```

---

## 5. 里程碑定义

### M1: 核心流程可运行

**达成条件**：
- [ ] 用户可从首页创建新会话
- [ ] 完成情绪自检后进入对话输入
- [ ] 提交对话后 AI 返回分析结果
- [ ] 流式渲染显示概览、时间线、双方视角

**关键验收**：
- 端到端流程无阻断
- AI 分析结果符合 Schema
- 安全检测正常工作（danger 级别阻断）

### M2: MVP 完整

**达成条件**：
- [ ] 四大误区框架展示完整
- [ ] 理解表达模板可编辑保存
- [ ] PDF 导出功能可用
- [ ] 暂停/恢复流程正常
- [ ] 响应式适配（移动端 tap 展开）

**关键验收**：
- 覆盖所有 Must 功能需求
- 安全三级机制完整（safe/caution/danger）

### M3: 体验优化

**达成条件**：
- [ ] 深呼吸引导动画
- [ ] 截图上传 + 多模态识别
- [ ] 情绪曲线可视化
- [ ] 历史记录管理

---

## 6. 技术要点

### 6.1 AI SDK 流式渲染

```typescript
// 前端使用 useObject hook
const { object, submit, isLoading } = useObject({
  api: '/api/analyze',
  schema: ConflictAnalysisSchema,
});

// 安全优先检查
if (object?.safety?.level === 'danger') {
  return <SafetyScreen />;
}

// 渐进式渲染
{object?.overview && <OverviewSection data={object.overview} />}
{object?.messages && <TimelineSection messages={object.messages} />}
```

### 6.2 IndexedDB 会话管理

```typescript
// 创建会话时生成 nanoid
const id = nanoid();
await db.sessions.add({ id, stage: 'calm_down', ... });

// 阶段流转
await db.sessions.update(id, { stage: 'input' });

// 30 天自动清理
db.sessions.where('createdAt').below(thirtyDaysAgo).delete();
```

### 6.3 安全机制协同

```
前端兜底 ─────────────────────────────────────────────
│
│  GlobalSafetyButton (始终可见)
│  LoadingWithSafetyHint (流式加载中)
│
AI 检测 ──────────────────────────────────────────────
│
│  safety.level === 'danger' → SafetyScreen
│  safety.level === 'caution' → CautionBanner
│  safety.level === 'safe' → 正常流程
```

---

## 7. 风险与注意事项

### 7.1 高风险项

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| AI 响应超时 | 用户体验中断 | 设置 maxDuration=60s + 错误重试 |
| 敏感内容检测失败 | 用户安全受威胁 | 前端兜底 + 求助热线始终可见 |
| IndexedDB 存储满 | 数据丢失 | 30 天自动清理 + 存储容量检测 |

### 7.2 开发注意事项

1. **Schema 先行**：所有业务开发前先完成 schemas，确保类型一致
2. **安全优先**：任何涉及用户输入展示的地方都要考虑 XSS 防护
3. **渐进增强**：核心功能不依赖 JavaScript 以外的特性
4. **移动优先**：样式从移动端开始，用 `md:` 前缀扩展桌面端

### 7.3 测试检查点

| 阶段 | 测试重点 |
|------|---------|
| Phase 1 | Schema 验证、数据库 CRUD |
| Phase 2 | 会话创建流程、情绪自检流程 |
| Phase 3 | AI 流式响应、安全检测触发 |
| Phase 4 | PDF 生成、断点续传 |

---

## 8. 附录：文件依赖图

```
schemas/
├── emotion.ts
├── dialogue.ts
├── analysis.ts ──────────┐
├── session.ts ◄──────────┴─ 依赖 emotion, dialogue, analysis
└── index.ts ◄───────────── 统一导出

db/
├── index.ts ◄───────────── 依赖 schemas
├── sessions.ts ◄────────── 依赖 db/index
└── insights.ts ◄────────── 依赖 db/index

contexts/
└── session-context.tsx ◄── 依赖 schemas, db/sessions

components/
├── ui/ ◄────────────────── 无依赖，可独立开发
├── layout/ ◄────────────── 依赖 ui
├── calm-down/ ◄─────────── 依赖 ui, schemas, constants
├── dialogue/ ◄──────────── 依赖 ui, schemas
├── analysis/ ◄──────────── 依赖 ui, schemas, hooks
├── insights/ ◄──────────── 依赖 ui, schemas, db/insights
├── reconnect/ ◄─────────── 依赖 ui, schemas
└── safety/ ◄────────────── 依赖 ui, constants

pages/
├── page.tsx ◄───────────── 依赖 ui, db/sessions
└── session/[id]/ ◄──────── 依赖 contexts, 各 components
```
