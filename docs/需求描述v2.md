# Conflict Archaeology v2

## 1. 产品摘要

**使命**：帮助陷入冲突的人在 15 分钟内完成"平复自己 → 理解对方 → 重建连接"的完整旅程。我们不是裁判，而是陪伴者。

**核心信念**（源自《我就是你啊》）：
> "世上并没有坏人，只有受苦的人。"
> "别把这看作是针对你的。"
> "在分歧与冲突中，谁能保持冷静，谁就是最强者。"

---

## 2. 背景洞察

### 书中核心智慧

1. **冲突升级三部曲**：解释 → 威胁 → 辱骂。大多数冲突都经历这三个步骤演化。
2. **四大认知误区**：
   | 我们以为的 | 真实情况 |
   |---|---|
   | 对方反对我 = 针对我 | 对方在保护自己的利益 |
   | 对方威胁我 = 想让我害怕 | 对方自己正在恐惧 |
   | 对方批评我 = 想伤害我 | 对方自己正在痛苦 |
   | 对方轻蔑我 = 看不起我 | 对方其实看不起自己 |

3. **化解冲突两步法**：
   - 第一步：平复自己的情绪（最难也最重要）
   - 第二步：平复他人的情绪（不唱反调，不做评判）

4. **理解的力量**："用自己的话把对方所说的复述一遍，会让对方敞开心扉。"

5. **善意假设原则**："先假设对方是善意的，除非有证据证明不是。"

### 用户痛点

1. 争执后情绪混乱，无法冷静思考
2. 习惯"找对方的错"，陷入指责循环
3. 想修复关系，但不知如何开口
4. 担心"被评判"或"再次被 gaslight"

---

## 3. 用户画像与 JTBD

| Persona | 核心痛点 | Job Statement | 成功标准 |
|---|---|---|---|
| 长期关系伴侣（核心） | 争吵后想修复但不知如何开口 | "当我与伴侣发生冲突后，我想理解 TA 真正害怕什么，以及我该如何表达理解" | 能说出"我理解你在担心..."并获得正向回应 |
| 远程团队伙伴 | 文字沟通容易误解 | "当文字沟通产生误会时，我想看到对方可能的真实想法" | 理解对方"反对"背后的利益诉求 |
| 家庭关系（亲子/手足） | 重复性冲突模式 | "当家庭冲突再次发生时，我想打破旧模式" | 识别自己的触发模式，提前预防 |

---

## 4. 设计原则

### 4.1 核心原则：不做裁判，只做镜子

- **不追究"谁先错"**：放弃 first_fossil 概念，改为识别"双方各自的恐惧/痛苦"
- **不给出"对错判断"**：只提供视角转换和理解框架
- **不代替用户决策**：提供选项，而非指令

### 4.2 体验原则

1. **先冷静，后理解**：用户必须完成情绪自检后才能进入分析环节
2. **先理解自己，再理解对方**：每个环节都先问"你可能在害怕/痛苦什么"
3. **不唱反调，不做评判**：系统语言永远温和、好奇、不评判
4. **可撤退性**：任何页面都可以"暂停，稍后继续"

### 4.3 语言原则

| 避免 | 改用 |
|---|---|
| "对方的错误" | "对方可能的担忧" |
| "你应该..." | "你可以考虑..." |
| "问题出在..." | "这里似乎发生了..." |
| "第一个裂缝" | "情绪开始变化的时刻" |

---

## 5. 体验蓝图（Journey Blueprint）

### 核心流程：四步旅程

```
[1. 平复自己] → [2. 理解双方] → [3. 视角转换] → [4. 重建连接]
     ↓               ↓               ↓               ↓
   情绪着陆         对话回顾         四大误区解读      表达理解练习
```

### 详细阶段

| 阶段 | 用户问题 | 系统责任 | 关键页面 |
|---|---|---|---|
| 0. 进入 | "我需要帮助" | 安全声明 + 说明系统角色（陪伴者，非裁判） | Landing |
| 1. 平复自己 | "我现在很乱" | 引导用户完成情绪自检和冷静练习 | Calm Down |
| 2. 理解双方 | "到底发生了什么" | 引导用户输入对话，识别双方各自的情绪和未说出口的需求 | Dialogue Review |
| 3. 视角转换 | "TA 为什么这样" | 用四大误区框架解读对方行为背后可能的恐惧/痛苦 | Perspective Shift |
| 4. 重建连接 | "我该怎么开口" | 帮助用户练习"表达理解"而非"解释自己" | Reconnect |
| 5. 沉淀 | "我想保存这次学习" | 导出总结，设置复盘提醒 | Export |

### 阶段详解

#### 阶段 1：平复自己（Calm Down）

**目标**：帮助用户从"战斗/逃跑"模式切换到"好奇/理解"模式

**内容**：
1. 情绪自检：当前感受（愤怒/委屈/焦虑/失望/冷漠）
2. 书中金句提醒：
   - "在分歧与冲突中，谁能保持冷静，谁就是最强者"
   - "恐惧和愤怒使我们失去思考能力"
3. 冷静小练习（可选）：
   - 深呼吸引导（3次）
   - "收住想要伸出的拳头"提示
4. 准备度确认："你觉得现在可以带着好奇心回顾这段对话了吗？"

**退出条件**：用户确认"可以了"或选择"稍后再来"

#### 阶段 2：理解双方（Dialogue Review）

**目标**：结构化回顾对话，识别双方各自的情绪和未说出口的需求

**输入方式**：
- 文字输入（推荐）
- 截图上传（OCR 后确认）

**分析框架**（对每条关键消息）：

```typescript
interface MessageInsight {
  originalText: string;
  speaker: '我' | 'TA';
  surfaceEmotion: string;       // 表面情绪
  possibleFear: string;         // 可能在害怕什么
  possiblePain: string;         // 可能在痛苦什么
  unspokenNeed: string;         // 未说出口的需求
  escalationType?: '解释' | '威胁' | '辱骂';  // 冲突升级阶段
}
```

**关键输出**：
- 对话时间线（标注情绪变化点，而非"谁先错"）
- 双方情绪曲线对比
- **重要**：不仅分析对方，也分析"我"的言行

**设计要点**：
- 每条消息都提供"我的视角"和"TA可能的视角"
- 不给"对/错"标签，只给"可能的解读"

#### 阶段 3：视角转换（Perspective Shift）

**目标**：用四大误区框架帮助用户重新理解对方的行为

**核心内容**：针对对话中的关键时刻，逐一应用四大误区框架

**示例呈现**：

```
你可能以为：「TA说'你从来不考虑我的感受'是在指责我」

另一个可能：「TA可能正在痛苦中，这句话更多是在表达自己的孤独感，
             而不是真的在评判你的人品」

书中智慧：「如果一个人表现得极具攻击性，是因为他自己正在痛苦当中」
```

**交互设计**：
- 每个误区解读都可以"保存"到个人洞察库
- 用户可以为每个解读写下自己的反思
- 支持"这个解读对我有帮助" / "这个不太对"的反馈

#### 阶段 4：重建连接（Reconnect）

**目标**：帮助用户准备一次"表达理解"的对话，而非"解释自己"的对话

**核心理念**：
> "我们总是乐于向别人解释为什么他们是错的，但其实我们最应该做的恰恰是表现出对别人观点有兴趣。"

**内容**：

1. **理解确认练习**：
   - 系统生成"你可能这样对 TA 说..."的模板
   - 核心结构："我理解你可能在担心/感到...，是这样吗？"
   - 用户可以修改、保存自己的版本

2. **开场白建议**（基于书中方法）：
   - "我想听听你的想法"
   - "你能告诉我你的顾虑是什么吗"
   - "我想确认我理解了你的意思"

3. **注意事项提醒**：
   - 避免：解释、威胁、反驳
   - 鼓励：好奇、确认、表达理解
   - 如果对方还在愤怒中："同意"、"好的"、"是的"

4. **时机建议**：
   - "等你内心重新冷静下来即可"
   - "距离和时间可以让愤怒平息"

**不做**：
- 不提供"三条行动建议"式的指令清单
- 不代替用户决定"什么时候说/怎么说"

---

## 6. 功能需求（MoSCoW）

| 优先级 | 功能 | 描述 | 验收标准 |
|---|---|---|---|
| **Must** | 情绪自检 | 用户进入分析前必须完成情绪确认 | 未完成自检无法进入下一步 |
| **Must** | 双向分析 | 分析"我"和"TA"双方的可能情绪/恐惧/需求 | 每条消息都有双视角解读（myPerspective + theirPerspective） |
| **Must** | 四大误区框架 | 将对话关键节点与四大误区对应 | 为精选的关键时刻提供 1-2 个最相关的误区框架解读 |
| **Must** | 安全模式 | 检测到危险信号时进入安全模式 | 只显示求助信息，暂停其他功能 |
| **Must** | 理解表达模板 | 生成"我理解你可能..."的对话模板 | 可编辑、可保存 |
| **Should** | 冷静练习引导 | 深呼吸、金句提醒等 | 用户可跳过 |
| **Should** | 洞察收藏 | 保存有启发的视角转换解读 | IndexedDB 本地存储 |
| **Should** | PDF 导出 | 导出本次旅程的核心洞察 | 包含双方分析、我的反思 |
| **Could** | 情绪曲线可视化 | 双方情绪随时间变化的曲线 | hover 查看原文 |
| **Could** | 历史对比 | 查看过去的冲突模式 | 识别重复触发点 |
| **Won't (v1)** | 实时双人协作 | — | 后续版本评估 |

---

## 7. 数据模型

### 7.1 设计原则

1. **整体视角优先**：分析结果是对整段对话的理解，不是逐条消息的机械标注
2. **扁平化**：减少不必要的嵌套，每个字段都有明确用途
3. **AI 输出友好**：Schema 应该是 AI 能自然生成的结构，避免过于复杂的约束

### 7.2 核心 Schema

```typescript
import { z } from 'zod';

/**
 * 用户输入：对话内容
 * 这是用户提交给系统的原始数据
 */
export const DialogueInputSchema = z.object({
  // 对话消息列表
  messages: z.array(z.object({
    speaker: z.enum(['我', 'TA']),
    text: z.string(),
  })),
  // 用户补充的背景信息（可选）
  context: z.string().optional(),
  // 截图（通过 LLM 多模态识别，非 OCR）
  images: z.array(z.object({
    base64: z.string(),
    mimeType: z.enum(['image/png', 'image/jpeg', 'image/webp']),
  })).optional(),
});

/**
 * 单方视角结构（用于双视角解读）
 */
export const PerspectiveSchema = z.object({
  emotion: z.string().describe('此刻可能的情绪'),
  fear: z.string().describe('可能在害怕/担心什么'),
  need: z.string().describe('未被满足的需求'),
});

/**
 * 逐条消息分析（用于时间线渲染）
 * 每条消息同时提供"我的视角"和"TA可能的视角"，满足双视角解读要求
 */
export const MessageInsightSchema = z.object({
  index: z.number().describe('消息在原始列表中的索引'),
  speaker: z.enum(['我', 'TA']),
  originalText: z.string(),
  // 双视角解读：无论消息由谁发出，都同时分析双方此刻的状态
  myPerspective: PerspectiveSchema.describe('我在这条消息时的视角'),
  theirPerspective: PerspectiveSchema.describe('TA在这条消息时可能的视角'),
  escalationType: z.enum(['正常', '解释', '威胁', '辱骂', '沉默']).optional(),
  isKeyMoment: z.boolean().describe('是否为关键时刻'),
});

/**
 * AI 输出：冲突分析结果
 * 这是 AI 返回的结构化分析，用于渲染各个页面
 */
export const ConflictAnalysisSchema = z.object({

  // ========== 安全评估（最高优先级，决定是否继续）==========
  safety: z.object({
    level: z.enum(['safe', 'caution', 'danger']),
    // 仅当 level 不是 safe 时需要
    concern: z.string().optional().describe('检测到的风险信号描述'),
  }),

  // ========== 冲突概览（用于"理解双方"页面顶部）==========
  overview: z.object({
    // 一句话概括这次冲突的核心
    oneLiner: z.string().describe('用一句话概括这次冲突的核心张力'),
    // 冲突如何升级的（解释→威胁→辱骂 模式）
    escalationPattern: z.string().describe('这次冲突的升级路径描述'),
  }),

  // ========== 逐条消息分析（用于时间线完整渲染）==========
  messages: z.array(MessageInsightSchema).describe('对每条消息的分析'),

  // ========== 双方视角汇总（用于"理解双方"页面主体）==========
  perspectives: z.object({
    // 我的视角
    mine: z.object({
      surfaceEmotion: z.string().describe('我整体呈现的情绪基调'),
      underlyingFear: z.string().describe('我可能在害怕/担心什么'),
      unmetNeed: z.string().describe('我未被满足的核心需求'),
    }),
    // TA的视角
    theirs: z.object({
      surfaceEmotion: z.string().describe('TA整体呈现的情绪基调'),
      underlyingFear: z.string().describe('TA可能在害怕/担心什么'),
      unmetNeed: z.string().describe('TA未被满足的核心需求'),
    }),
  }),

  // ========== 关键时刻（从 messages 中精选，最多3个）==========
  keyMoments: z.array(z.object({
    messageIndex: z.number().describe('对应 messages 数组的索引'),
    quote: z.string().describe('引用原文'),
    speaker: z.enum(['我', 'TA']),
    significance: z.string().describe('这个时刻为什么重要'),
    myFeeling: z.string().describe('我在这个时刻可能的感受'),
    theirFeeling: z.string().describe('TA在这个时刻可能的感受'),
  })).max(3),

  // ========== 误区洞察（精选最相关的，最多2个）==========
  insights: z.array(z.object({
    // 四大误区类型
    type: z.enum([
      '反对不等于针对',   // 对方反对 ≠ 针对我
      '威胁源于恐惧',     // 对方威胁 = 对方在害怕
      '批评源于痛苦',     // 对方批评 = 对方在痛苦
      '轻蔑源于自卑',     // 对方轻蔑 = 对方自卑
    ]),
    // 关联的消息索引（可选）
    relatedMessageIndex: z.number().optional(),
    // 具体应用到这次冲突
    theirBehavior: z.string().describe('TA的具体行为'),
    youMightThink: z.string().describe('你可能以为...'),
    alternativeView: z.string().describe('另一个可能是...'),
    // 书中智慧引用
    bookQuote: z.string().describe('相关的书中原话'),
  })).max(2),

  // ========== 重建连接（用于"重建连接"页面）==========
  reconnection: z.object({
    // 核心理解表达（最重要的一句话）
    coreUnderstanding: z.string().describe('我理解你可能...'),
    // 完整话术示例
    sampleScript: z.string().describe('完整的对话示例，包含开场和确认'),
    // 时机建议
    timingAdvice: z.string().describe('什么时候适合开启这个对话'),
  }),
});

/**
 * 用户情绪自检（用于"平复自己"页面）
 */
export const EmotionCheckInSchema = z.object({
  emotion: z.enum(['愤怒', '委屈', '焦虑', '失望', '冷漠', '混乱', '其他']),
  intensity: z.number().min(1).max(5),
  readyToProceed: z.boolean(),
});

/**
 * 用户保存的洞察（用于收藏功能）
 */
export const SavedInsightSchema = z.object({
  id: z.string(),
  type: z.enum(['反对不等于针对', '威胁源于恐惧', '批评源于痛苦', '轻蔑源于自卑']),
  content: z.object({
    theirBehavior: z.string(),
    alternativeView: z.string(),
  }),
  userNote: z.string().optional(),  // 用户自己的反思
  savedAt: z.string(),
});

/**
 * 会话状态（用于断点续传）
 */
export const SessionSchema = z.object({
  id: z.string(),
  // 阶段枚举：包含完整流程阶段 + 暂停状态
  stage: z.enum([
    'calm_down',   // 阶段1：平复自己
    'input',       // 阶段2：输入对话
    'analyzing',   // 分析中（过渡态）
    'review',      // 阶段2结果：理解双方
    'insights',    // 阶段3：视角转换
    'reconnect',   // 阶段4：重建连接
    'export',      // 阶段5：沉淀与导出
    'complete',    // 完成
    'paused',      // 暂停状态（用于断点续传）
  ]),
  pausedFromStage: z.enum(['calm_down', 'input', 'analyzing', 'review', 'insights', 'reconnect', 'export']).optional(),
  emotionCheckIn: EmotionCheckInSchema.optional(),
  dialogueInput: DialogueInputSchema.optional(),
  analysis: ConflictAnalysisSchema.optional(),
  savedInsights: z.array(SavedInsightSchema).optional(),
  createdAt: z.string(),
  updatedAt: z.string(),
});
```

### 7.3 为什么这样设计

| 设计决策 | 说明 |
|---|---|
| `MessageInsight` 包含 `myPerspective` 和 `theirPerspective` | 满足"每条消息都有双视角解读"的验收标准，无论消息由谁发出都同时分析双方视角 |
| `keyMoments.messageIndex` 关联 messages | 关键时刻从逐条分析中精选，保持数据一致性 |
| `insights` 独立且最多2个 | 误区是整体行为模式解读，精选最相关的避免信息过载 |
| `perspectives` 作为汇总 | 在逐条分析基础上，提供双方整体视角的概括 |
| `SessionSchema.stage` 包含 `export` 和 `paused` | 支持完整的5阶段流程和暂停续传功能 |
| 枚举统一使用中文 | 产品面向中文用户，减少翻译歧义 |
| `images` 字段支持多模态 | 截图通过 LLM 多模态能力识别，非传统 OCR |

---

## 8. AI 策略

### 8.1 核心原则：单轮结构化输出

**唯一调用模式**：`streamObject` / `generateObject` + Zod Schema 校验

| 不使用 | 原因 |
|---|---|
| 自定义 Tools | 本场景输入输出确定，无需模型"决定做什么" |
| `streamText` + Tools | 无外部 API 调用，无多步决策需求 |
| 多轮对话 | 一次性分析即可，无需追问 |

### 8.2 调用方式

```typescript
import { streamObject } from 'ai';
import { openai } from '@ai-sdk/openai';
import { ConflictAnalysisSchema } from '@/lib/schemas';

export async function analyzeConflict(input: DialogueInput) {
  const result = streamObject({
    model: openai('gpt-4o'),
    schema: ConflictAnalysisSchema,
    system: SYSTEM_PROMPT,
    prompt: formatPrompt(input),
    temperature: 0.3,

    onFinish({ object }) {
      // 分析完成，保存结果
      console.log('Analysis complete:', object);
    },
  });

  return result;
}
```

### 8.3 流式渲染数组示例

当需要逐条流式渲染消息分析时，使用 `output: 'array'` 配合 `elementStream`：

```typescript
import { streamObject } from 'ai';
import { MessageInsightSchema } from '@/lib/schemas';

// 独立的消息分析流（可选，用于分步渲染）
export async function streamMessageAnalysis(messages: string[]) {
  const result = streamObject({
    model: openai('gpt-4o'),
    output: 'array',
    schema: MessageInsightSchema,
    system: MESSAGE_ANALYSIS_PROMPT,
    prompt: `分析以下对话消息：\n${messages.join('\n')}`,
  });

  // 逐条消息流式输出
  for await (const insight of result.elementStream) {
    console.log('New message insight:', insight);
    // 实时更新 UI
  }

  return result;
}
```

### 8.4 多模态输入（截图识别）

截图通过 LLM 多模态能力识别，**不使用传统 OCR**：

```typescript
import { streamObject } from 'ai';
import { openai } from '@ai-sdk/openai';

export async function analyzeWithImages(input: DialogueInput) {
  const messages = [];

  // 如果有截图，作为图片内容传入
  if (input.images?.length) {
    messages.push({
      role: 'user' as const,
      content: [
        { type: 'text' as const, text: '请识别以下聊天截图中的对话内容：' },
        ...input.images.map(img => ({
          type: 'image' as const,
          image: img.base64,
        })),
      ],
    });
  }

  // 添加文字对话（如果有）
  if (input.messages?.length) {
    messages.push({
      role: 'user' as const,
      content: formatPrompt(input),
    });
  }

  return streamObject({
    model: openai('gpt-4o'),  // 支持多模态
    schema: ConflictAnalysisSchema,
    system: SYSTEM_PROMPT,
    messages,
    temperature: 0.3,
  });
}
```

### 8.5 System Prompt

```typescript
const SYSTEM_PROMPT = `你是一位温和、好奇、不评判的陪伴者。你的角色不是裁判，而是帮助用户理解自己和对方。

## 核心信念
- "世上并没有坏人，只有受苦的人。"
- "别把这看作是针对你的。"
- "先假设对方是善意的，除非有证据证明不是。"

## 你的任务
1. **安全评估优先**：如果存在人身威胁或自伤信号，立即标记 safety.level = 'danger'
2. **逐条消息分析**：为每条消息提供双视角解读（myPerspective + theirPerspective），无论消息由谁发出都同时分析双方此刻的情绪、恐惧和需求
3. **精选关键时刻**：从消息中选出最重要的2-3个转折点
4. **误区框架应用**：选择1-2个最相关的四大误区进行解读
5. **生成理解话术**：帮助用户"表达理解"而非"解释自己"

## 四大认知误区框架
1. 反对不等于针对：当对方反对时，不是针对我，是在保护自己的利益
2. 威胁源于恐惧：当对方威胁时，不是想吓我，是自己正在恐惧
3. 批评源于痛苦：当对方批评时，不是想伤害我，是自己正在痛苦
4. 轻蔑源于自卑：当对方轻蔑时，不是看不起我，是看不起自己

## 语言要求
- 永远使用"可能"、"也许"、"一个角度是"等非断言性语言
- 避免"应该"、"必须"、"错误"等评判性语言
- 分析"我"的言行时同样保持善意假设
- 书中引用要准确，使用原文

## 安全检测指南
识别以下信号时，将 safety.level 设为 'danger'：
- 人身伤害威胁（明确的打、杀、伤害意图）
- 自伤/自杀信号
- 严重的精神控制描述

识别以下信号时，将 safety.level 设为 'caution'：
- 持续性冷暴力
- 反复的威胁性语言
- 经济控制或社交隔离描述

## 输出要求
- messages 数组长度应与输入消息数量一致
- 每条消息必须包含 myPerspective 和 theirPerspective 双视角
- keyMoments 通过 messageIndex 关联到 messages
- insights 最多2个，选择最相关的误区框架`;
```

### 8.6 Prompt 模板

```typescript
function formatPrompt(input: DialogueInput): string {
  const messagesText = input.messages
    .map((m, i) => `[${i}] ${m.speaker}：${m.text}`)
    .join('\n');

  return `请分析以下对话中的冲突：

## 对话内容
${messagesText}

${input.context ? `## 用户补充背景\n${input.context}` : ''}

请按照 schema 结构返回分析结果。注意：
1. safety 评估是最高优先级，必须首先输出
2. messages 数组应包含对每条消息的分析，每条消息都需要同时提供 myPerspective 和 theirPerspective
3. keyMoments 通过 messageIndex 关联到 messages
4. insights 最多选择2个最相关的误区框架
5. reconnection.sampleScript 要自然、可直接使用`;
}
```

### 8.7 前端流式渲染

```typescript
'use client';

import { experimental_useObject as useObject } from '@ai-sdk/react';
import { useEffect } from 'react';
import { ConflictAnalysisSchema, DialogueInput } from '@/lib/schemas';

export function AnalysisPage({ input }: { input: DialogueInput }) {
  // useObject 返回 submit 函数用于触发请求
  const { object, submit, isLoading, error } = useObject({
    api: '/api/analyze',
    schema: ConflictAnalysisSchema,
  });

  // 组件挂载时自动提交分析请求
  useEffect(() => {
    submit(input);
  }, [submit, input]);

  // 安全优先：一旦检测到危险，立即显示
  if (object?.safety?.level === 'danger') {
    return <SafetyScreen concern={object.safety.concern} />;
  }

  return (
    <div>
      {/* 加载状态 */}
      {isLoading && <LoadingWithSafetyHint />}

      {/* 错误处理 */}
      {error && <ErrorMessage error={error} />}

      {/* 渐进式显示各部分 */}
      {object?.overview && <OverviewSection data={object.overview} />}
      {object?.messages && <TimelineSection messages={object.messages} />}
      {object?.perspectives && <PerspectivesSection data={object.perspectives} />}
      {object?.keyMoments && <KeyMomentsSection moments={object.keyMoments} />}
      {object?.insights && <InsightsSection insights={object.insights} />}
      {object?.reconnection && <ReconnectionSection data={object.reconnection} />}
    </div>
  );
}
```

### 8.8 错误处理

```typescript
// API Route
export async function POST(req: Request) {
  try {
    const input = await req.json();
    const result = await analyzeConflict(input);
    return result.toTextStreamResponse();
  } catch (error) {
    console.error('Analysis failed:', error);
    return new Response(
      JSON.stringify({
        error: '分析过程中遇到问题，请稍后重试',
      }),
      { status: 500 }
    );
  }
}
```

---

## 9. 安全策略

### 9.1 双保险机制：AI 检测 + 前端兜底

**原则**：AI 负责语境理解和风险评估，前端提供兜底保护

| 层级 | 职责 | 说明 |
|---|---|---|
| AI 检测 | 理解语境，判断 safety.level | 能区分"我气死了"和真正的威胁 |
| 前端兜底 | 流式未返回时的保护 | 确保用户任何时刻都能获取求助信息 |

### 9.2 前端兜底措施

```typescript
// 1. 全局求助入口（始终可见）
export function GlobalSafetyButton() {
  return (
    <button
      className="fixed bottom-4 right-4 text-sm text-gray-500"
      onClick={() => setShowSafetyResources(true)}
    >
      需要帮助？
    </button>
  );
}

// 2. 分析页面的安全检查
export function AnalysisPage() {
  const { object, isLoading } = useObject({ /* ... */ });

  // AI 判定的危险
  if (object?.safety?.level === 'danger') {
    return <SafetyScreen concern={object.safety.concern} />;
  }

  // 流式加载中也显示兜底提示
  return (
    <div>
      {isLoading && <LoadingWithSafetyHint />}
      {/* ... 其他内容 */}
      <CautionBanner show={object?.safety?.level === 'caution'} />
      <GlobalSafetyButton />
    </div>
  );
}

// 3. 加载状态的安全提示
function LoadingWithSafetyHint() {
  return (
    <div className="text-center py-8">
      <Spinner />
      <p className="mt-4 text-gray-600">正在分析中...</p>
      <p className="mt-2 text-sm text-gray-400">
        如果你现在感到不安全，
        <button className="underline" onClick={showSafetyResources}>
          点击这里获取帮助
        </button>
      </p>
    </div>
  );
}
```

### 9.3 断点续传与情绪边界

```typescript
// 用户可以随时暂停
export function PauseButton({ sessionId }: { sessionId: string }) {
  const handlePause = async () => {
    await saveSession(sessionId, { pausedAt: new Date().toISOString() });
    router.push('/paused');
  };

  return (
    <button onClick={handlePause} className="text-gray-500">
      暂停，稍后继续
    </button>
  );
}

// 暂停页面
export function PausedPage() {
  return (
    <div className="text-center py-12">
      <h1>已暂停</h1>
      <p className="mt-4 text-gray-600">
        情绪需要时间平复。当你准备好了，可以继续。
      </p>
      <div className="mt-8 space-x-4">
        <button onClick={resumeSession}>继续</button>
        <button onClick={startNew}>重新开始</button>
      </div>
      <p className="mt-8 text-sm text-gray-400">
        如果你需要帮助：
        <a href="tel:400-161-9995">400-161-9995</a>
      </p>
    </div>
  );
}
```

### 9.4 三级安全机制

| 级别 | AI 判断依据 | 系统行为 |
|---|---|---|
| `safe` | 正常的关系冲突、情绪表达 | 正常流程 |
| `caution` | 持续冷暴力、反复威胁性语言、控制性行为 | 底部显示资源提醒，继续分析 |
| `danger` | 人身伤害威胁、自伤/自杀信号、严重精神控制 | 立即中断，只显示求助信息 |

### 9.5 安全模式 UI

当 `safety.level === 'danger'` 时：

```
┌─────────────────────────────────────────┐
│                                         │
│         你的安全是最重要的               │
│                                         │
│  如果你正在经历或担心人身安全问题，       │
│  请寻求专业帮助：                        │
│                                         │
│  • 全国心理援助热线：400-161-9995        │
│  • 妇女维权热线：12338                  │
│  • 紧急情况：110                        │
│                                         │
│  ┌─────────────┐  ┌─────────────┐       │
│  │ 我现在安全  │  │    退出     │       │
│  └─────────────┘  └─────────────┘       │
│                                         │
└─────────────────────────────────────────┘
```

当 `safety.level === 'caution'` 时，在页面底部显示：

```
┌─────────────────────────────────────────┐
│ ⚠️ 如果你在这段关系中感到不安全，这里有 │
│    一些资源可以帮助你：[查看资源]        │
└─────────────────────────────────────────┘
```

### 9.6 求助热线本地缓存

```typescript
// 求助热线信息本地缓存，确保离线也能显示
const SAFETY_RESOURCES = {
  hotlines: [
    { name: '全国心理援助热线', number: '400-161-9995' },
    { name: '妇女维权热线', number: '12338' },
    { name: '紧急报警', number: '110' },
  ],
  // 存入 localStorage，确保始终可用
};

// 应用启动时缓存
if (typeof window !== 'undefined') {
  localStorage.setItem('safety_resources', JSON.stringify(SAFETY_RESOURCES));
}
```

---

## 10. 技术架构

### 10.1 前端

- **框架**：Next.js 15 App Router
- **样式**：Tailwind CSS v4
- **动效**：Framer Motion
- **图标**：Lucide React
- **状态**：React Context + IndexedDB (Dexie)

### 10.2 AI 层

- **SDK**：Vercel AI SDK (`ai` package)
- **Provider**：OpenAI / Anthropic（通过统一接口）
- **调用模式**：`streamObject` / `generateObject` + Zod 校验（唯一路径）

### 10.3 响应式设计约束

| 断点 | 说明 |
|---|---|
| `≥1024px` | 桌面端，完整布局 |
| `<1024px` | 移动端，适配触摸 |

**移动端适配要求**：

| 场景 | 桌面端 | 移动端 |
|---|---|---|
| 时间线消息详情 | Hover 显示 | Tap 展开/折叠 |
| 情绪曲线图 | 完整显示 | 横向滚动或折叠 |
| 长文本输入 | 单页表单 | 分步表单 |
| 截图上传 | 拖拽上传 | 相册选择 + 粘贴板提示 |
| 触摸命中区 | — | 最小 44x44px |

**性能预算**：

| 指标 | 目标 |
|---|---|
| 首屏加载 (LCP) | < 2.5s |
| 交互延迟 (FID) | < 100ms |
| 流式首字输出 | < 1s |

```typescript
// 响应式 Hook 示例
function useIsMobile() {
  const [isMobile, setIsMobile] = useState(false);
  useEffect(() => {
    const check = () => setIsMobile(window.innerWidth < 1024);
    check();
    window.addEventListener('resize', check);
    return () => window.removeEventListener('resize', check);
  }, []);
  return isMobile;
}

// 时间线消息组件适配
function MessageItem({ insight }: { insight: MessageInsight }) {
  const isMobile = useIsMobile();
  const [expanded, setExpanded] = useState(false);

  if (isMobile) {
    return (
      <div onClick={() => setExpanded(!expanded)}>
        <p>{insight.originalText}</p>
        {expanded && <MessageDetails insight={insight} />}
      </div>
    );
  }

  return (
    <div className="group">
      <p>{insight.originalText}</p>
      <div className="hidden group-hover:block">
        <MessageDetails insight={insight} />
      </div>
    </div>
  );
}
```

### 10.4 数据存储与隐私

**存储架构**：

| 数据类型 | 存储位置 | 保留期 | 清除入口 |
|---|---|---|---|
| 会话数据 | IndexedDB | 30天 | 设置页 > 清除数据 |
| 用户反思 | IndexedDB | 永久（用户主动删除） | 历史记录 > 删除 |
| 情绪自检记录 | IndexedDB | 30天 | 自动清理 |
| 求助热线 | localStorage | 永久 | — |

**隐私声明要点**：

1. **本地优先**：所有对话数据仅存储在用户设备本地（IndexedDB）
2. **API 调用**：对话内容发送至 AI 服务商进行分析，传输使用 HTTPS 加密
3. **无服务端存储**：MVP 阶段不在服务端存储任何用户数据
4. **用户控制**：用户可随时清除所有本地数据

```typescript
// IndexedDB 数据库配置
import Dexie from 'dexie';

class ConflictArchaeologyDB extends Dexie {
  sessions!: Table<Session>;
  insights!: Table<SavedInsight>;

  constructor() {
    super('ConflictArchaeologyDB');
    this.version(1).stores({
      sessions: 'id, stage, createdAt, updatedAt',
      insights: 'id, type, savedAt',
    });
  }
}

// 自动清理 30 天前的会话
async function cleanupOldSessions() {
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

  await db.sessions
    .where('createdAt')
    .below(thirtyDaysAgo.toISOString())
    .delete();
}
```

**截图处理说明**：

- 截图通过 **LLM 多模态能力** 识别对话内容，非传统 OCR
- 图片以 base64 格式传输，使用 HTTPS 加密
- 图片不在服务端持久化存储
- 前端使用浏览器内存 URL（`createObjectURL`），不缓存到 CDN

### 10.5 导出

- **PDF**：`pdf-lib`
- **内容**：双方分析摘要 + 关键时刻 + 误区洞察 + 我的反思 + 理解表达模板

---

---

## 12. 项目计划

| 阶段 | 范围 | 预计周期 | 里程碑 |
|---|---|---|---|
| Phase 1 | 平复自己 + 对话分析 + 基础视角转换 | 3 周 | 核心流程可用 |
| Phase 2 | 理解表达模板 + PDF导出 + 历史记录 | 2 周 | MVP 完整 |
| Phase 3 | 情绪曲线可视化 + 冷静练习增强 | 2 周 | 体验优化 |
| Phase 4 | 用户反馈迭代 + 模型微调 | 持续 | 根据数据优化 |

---


---

## 14. 开放问题

1. **是否需要引导用户先写"我自己的感受"再上传对话？**
   - 优点：帮助用户先觉察自己
   - 缺点：增加流程长度

2. **四大误区是否需要全部呈现，还是只呈现最相关的？**
   - 全部呈现：教育价值高，但可能信息过载
   - 精选呈现：更聚焦，但可能遗漏

3. **是否支持"模拟对话练习"功能？**
   - 用户与 AI 角色扮演，练习表达理解
   - 风险：AI 可能无法准确扮演对方

4. **多语言支持优先级？**
   - MVP 仅中文
   - 英文版本计划？

---

## 附录：书中关键引用

> "威胁向来都是没用的。除非你是想故意引诱对方对你发出威胁。"

> "恐惧和愤怒使得他们失去了思考的能力。他们开始变得特别擅长做些荒唐事，损害自己的利益。"

> "拒绝、争吵、威胁、攻击性，实际上这些情绪都与你毫无关系，全都是对方自己的事情，完全与你无关。"

> "用自己的话把他所说的复述一遍，这会使得他改变自己的态度。就像这门一样，锁会自己打开。这样做会让对方敞开心扉！"

> "我们先假设对方是善意的，除非有什么证据能证明他们不是。"

> "唱反调和做评判是永远不会有效的，反之，还会加剧冲突。"

> "当我们感觉内心出现了想要攻击对方的冲动时，我们需要尽力抑制住它。"

> "等到你内心重新冷静下来即可。"
